---
apiVersion: v1
kind: ConfigMap
metadata:
  name: paperless-export-scripts
  namespace: paperless-ngx
data:
  auto-export.py: |
    #!/usr/bin/env python3
    """
    Paperless-NGX Auto-Export Script
    Setzt automatisch Tags basierend auf Dokumentinhalt und exportiert in passende Ordner
    """
    import os
    import sys
    import re
    import shutil
    from pathlib import Path

    # Wichtig: Python-Pfad fÃ¼r Paperless
    sys.path.insert(0, '/usr/src/paperless/src')
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'paperless.settings')

    import django
    django.setup()

    from documents.models import Document, Tag

    # Keyword-basierte Tag-Zuordnung (Regex-Patterns)
    TAG_PATTERNS = {
        "Auto": [
            r"(?i)kfz|fahrzeug|auto|pkw|kraftfahrzeug|zulassung|fÃ¼hrerschein|tankstelle|werkstatt|reifen|tÃ¼v|hauptuntersuchung|kravag|huk.?coburg|allianz.?auto"
        ],
        "Versicherung": [
            r"(?i)versicherung|police|prÃ¤mie|schadensmeldung|versicherungsschein|haftpflicht|kasko|hausrat|lebensversicherung|krankenversicherung|berufsunfÃ¤higkeit"
        ],
        "Finanzen": [
            r"(?i)rechnung|invoice|zahlung|Ã¼berweisung|kontoauszug|bank|sparkasse|volksbank|commerzbank|deutsche.?bank|ing.?diba|konto|kredit|darlehen|steuer(?!er)|finanzamt|elster"
        ],
        "Wohnung": [
            r"(?i)miete|mietvertrag|nebenkosten|hausverwaltung|wohnung|vermieter|kaution|betriebskosten|heizkosten|strom|gas|wasser|stadtwerke|enbw|vattenfall"
        ],
        "Gesundheit": [
            r"(?i)arzt|krankenhaus|apotheke|rezept|krankenkasse|aok|tk|barmer|dak|medikament|behandlung|diagnose|Ã¼berweisung|heilpraktiker|zahnarzt|labor"
        ],
        "Arbeit": [
            r"(?i)arbeitsvertrag|gehalt|lohnabrechnung|arbeitgeber|kÃ¼ndigung|zeugnis|bewerbung|arbeitsamt|agentur.?fÃ¼r.?arbeit|jobcenter"
        ],
        "Familie": [
            r"(?i)geburtsurkunde|heiratsurkunde|scheidung|kindergeld|elterngeld|familienkasse|standesamt|kinderbetreuung|schule|kita|kindergarten"
        ],
        "BehÃ¶rde": [
            r"(?i)behÃ¶rde|amt|rathaus|bÃ¼rgeramt|finanzamt|standesamt|meldebescheinigung|personalausweis|reisepass|fÃ¼hrerschein|bescheid|antrag"
        ],
    }

    # Tag zu Export-Ordner Mapping
    TAG_TO_FOLDER = {
        "Auto": "Auto",
        "Versicherung": "Finanz/Versicherungen",
        "Finanzen": "Finanz",
        "Wohnung": "Wohnung",
        "Gesundheit": "Gesundheit",
        "Arbeit": "Arbeit",
        "Familie": "Familie allg",
        "BehÃ¶rde": "BehÃ¶rde",
    }

    def auto_tag_document(document):
        """Setzt automatisch Tags basierend auf dem Dokumentinhalt"""
        content = document.content or ""
        title = document.title or ""
        search_text = f"{title} {content}"
        
        assigned_tags = []
        
        for tag_name, patterns in TAG_PATTERNS.items():
            for pattern in patterns:
                if re.search(pattern, search_text):
                    # Tag erstellen oder finden
                    tag, created = Tag.objects.get_or_create(name=tag_name)
                    if tag not in document.tags.all():
                        document.tags.add(tag)
                        assigned_tags.append(tag_name)
                        print(f"  ðŸ“Ž Tag '{tag_name}' hinzugefÃ¼gt")
                    break  # Nur ein Match pro Tag-Kategorie
        
        if assigned_tags:
            document.save()
        
        return assigned_tags

    def get_export_path(document):
        """Bestimmt den Export-Pfad basierend auf Tags"""
        base_export = Path("/usr/src/paperless/export")
        
        # PrÃ¼fe Tags
        for tag in document.tags.all():
            if tag.name in TAG_TO_FOLDER:
                return base_export / TAG_TO_FOLDER[tag.name]
        
        # PrÃ¼fe Correspondent als Fallback
        if document.correspondent:
            corresp_name = document.correspondent.name.lower()
            for tag_name, folder in TAG_TO_FOLDER.items():
                if tag_name.lower() in corresp_name:
                    return base_export / folder
        
        # Fallback
        return base_export / "Sonstiges"

    def export_document(document_id):
        """Exportiert ein Dokument in den passenden Ordner"""
        try:
            doc = Document.objects.get(id=document_id)
            print(f"ðŸ“„ Verarbeite: {doc.title}")
            
            # 1. Automatisch Tags setzen
            auto_tag_document(doc)
            
            # 2. Quell-Datei finden
            if doc.archive_filename:
                source_file = Path(f"/usr/src/paperless/media/documents/archive/{doc.archive_filename}")
            else:
                source_file = Path(f"/usr/src/paperless/media/documents/originals/{doc.filename}")
            
            if not source_file.exists():
                print(f"  âŒ Quelldatei nicht gefunden: {source_file}")
                return False
            
            # 3. Ziel-Ordner bestimmen
            export_dir = get_export_path(doc)
            export_dir.mkdir(parents=True, exist_ok=True)
            
            # 4. Dateiname: YYYY-MM-DD Titel.pdf
            date_str = doc.created.strftime("%Y-%m-%d") if doc.created else "0000-00-00"
            safe_title = "".join(c for c in doc.title if c.isalnum() or c in (' ', '-', '_', 'Ã¤Ã¶Ã¼Ã„Ã–ÃœÃŸ')).strip()[:100]
            filename = f"{date_str} {safe_title}{source_file.suffix}"
            
            export_path = export_dir / filename
            
            # 5. Nur kopieren wenn nicht schon vorhanden
            if export_path.exists():
                print(f"  â­ï¸  Bereits vorhanden: {export_path.name}")
                return True
            
            shutil.copy2(source_file, export_path)
            print(f"  âœ… Exportiert nach: {export_dir.name}/{filename}")
            return True
            
        except Document.DoesNotExist:
            print(f"âŒ Dokument {document_id} nicht gefunden")
            return False
        except Exception as e:
            print(f"âŒ Fehler: {e}")
            import traceback
            traceback.print_exc()
            return False

    if __name__ == "__main__":
        # Paperless Ã¼bergibt DOCUMENT_ID als Umgebungsvariable
        document_id = os.environ.get('DOCUMENT_ID')
        
        if not document_id and len(sys.argv) > 1:
            document_id = sys.argv[1]
        
        if not document_id:
            print("Keine DOCUMENT_ID gefunden")
            sys.exit(1)
        
        success = export_document(int(document_id))
        sys.exit(0 if success else 1)

  export-all.py: |
    #!/usr/bin/env python3
    """Exportiert alle existierenden Dokumente"""
    import os
    import sys

    sys.path.insert(0, '/usr/src/paperless/src')
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'paperless.settings')

    import django
    django.setup()

    from documents.models import Document

    # Import the main script
    exec(open('/usr/src/paperless/scripts/auto-export.py').read())

    print("=" * 50)
    print("Exportiere alle Dokumente...")
    print("=" * 50)
    
    total = Document.objects.count()
    for i, doc in enumerate(Document.objects.all(), 1):
        print(f"\n[{i}/{total}]", end=" ")
        export_document(doc.id)
    
    print("\n" + "=" * 50)
    print(f"Fertig! {total} Dokumente verarbeitet.")
    print("=" * 50)
