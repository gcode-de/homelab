apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: multipath-guard
  namespace: kube-system
  labels:
    app: multipath-guard
spec:
  selector:
    matchLabels:
      app: multipath-guard
  template:
    metadata:
      labels:
        app: multipath-guard
    spec:
      hostPID: true
      containers:
      - name: multipath-guard
        image: alpine:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Checking multipathd status..."
            if nsenter -m/proc/1/ns/mnt -- systemctl is-active --quiet multipathd; then
              echo "multipathd is active. Disabling it to prevent Longhorn conflicts..."
              nsenter -m/proc/1/ns/mnt -- systemctl stop multipathd
              nsenter -m/proc/1/ns/mnt -- systemctl disable multipathd
              echo "multipathd disabled."
            else
              echo "multipathd is already inactive."
            fi
            
            # Keep pod running to prevent restart loop, but check periodically
            while true; do sleep 3600; done
        securityContext:
          privileged: true
